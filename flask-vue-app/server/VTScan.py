import json
import requests
import analyze as a
import os
import sys
import time
from configparser import ConfigParser


api_url = "https://www.virustotal.com/api/v3/users/id"
api_url_file_scan = 'https://www.virustotal.com/vtapi/v2/file/scan'
api_url_report = 'https://www.virustotal.com/vtapi/v2/file/report'

config = ConfigParser()
config.read('../../config.ini')
api_key = config['virustotal']['api_key']

params = dict(apikey=api_key)
filePath = '/Users/AndMal2020-Dynamic-BeforeAndAfterReboot.zip'


session = requests.Session()

sample_dir = 'sample/'

def check_connection():
    print('Establishing connection...')
    headers = {"x-apikey": api_key}
    session.headers.update(headers)
    response = session.request("GET", api_url)
    if response.status_code == 200:
        print("Connection succesfull")
    else:
        print(response.content)
        sys.exit()
    
def scanFile(inputFile):
    files = {'file': (inputFile, open(inputFile, 'rb'))} #dict(file=(inputFile, file))
    response = session.post(api_url_file_scan, files=files, params=params)
    if response.status_code == 200:
        result =response.json()
        resource = result["resource"]
        time.sleep(5)
        paramsReport = dict(apikey=api_key, resource=resource)
        responseReport = session.get(api_url_report, params=paramsReport)
        if responseReport.status_code == 200:
            resultReport = responseReport.json()
            with open('VirusTotal.json', 'w') as json_file:
                json.dump(resultReport, json_file, sort_keys=False, indent=4)
            return os.path.realpath(json_file.name)
        


def controller(inputFile, reportType):
    check_connection()
    outputFilePath = scanFile(inputFile)
    output = a.startAnalysis(outputFilePath, reportType)
    return output