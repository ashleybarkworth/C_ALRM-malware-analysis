<template>
  <b-container>
    <b-container>
    <b-row class="mb-2 col-md-7 col-sm-1 col-lg-7" id="title">
      <b-col>
        <h1><img src="@/assets/logo2.png" width="20%" height="20%"/>ALRM</h1>
        <div><br>
          <b-form-file v-model="file" size="sm" ref="file-input" class="mb-2"
          placeholder="Choose a file or drop it here..."
          drop-placeholder="Drop file here...">
          </b-form-file>
          <b-button @click="clearFiles" variant="danger" class="mr-2">RESET</b-button>
          <b-button @click="submitFile" variant="success" class="mr-2">SUBMIT FILE</b-button>
        </div>
        <!--<alert :message=message  v-if="submitted"></alert>-->
        <br />
        <div>
          <b-button variant="primary" v-if="processing" disabled>
            <b-spinner small type="grow"></b-spinner>
            Loading...
            </b-button>
        </div>
      </b-col>
    </b-row>
    </b-container>
    <b-row v-if="reportFetched">
    <br />
      <b-container fluid>
          <b-row>
            <h4> Results for {{ file.name }} </h4>
          </b-row>
          <hr />
          <br />
          <b-row class="mb-3">
            <b-col class="md-4">
              <b-row class="mb-3">
                <b-card class="mb-2">
                  <b-card-body>
                    <b-card-title>Quick Overview</b-card-title>
                  </b-card-body>

                  <div id="donut">
                    <h5>Threat Score</h5>
                    <vc-donut
                    :sections="sections"
                    background="#222b45" foreground="grey"
                    :size="6" unit="rem" :thickness="10"
                    :auto-adjust-text-size="false"
                    :text="threat_score"
                    >
                    </vc-donut>
                  </div>

                  <b-list-group flush>
                    <b-list-group-item class="info">
                    {{ report[0]["FileName"] === 'NA' ? 'Unknown'
                     : report[0]["FileName"] === 'NA' }}</b-list-group-item>
                    <b-list-group-item class="label">File</b-list-group-item>
                    <b-list-group-item class="info">{{ report[0]["Hash"] }}
                    </b-list-group-item>
                    <b-list-group-item class="label">SHA256</b-list-group-item>
                    <b-list-group-item class="info">{{ report[1]["Family"] }}
                    </b-list-group-item>
                    <b-list-group-item class="label">Malware Family</b-list-group-item>
                  </b-list-group>
                </b-card>
                </b-row>
                <b-row>
                  <b-card
                  width="100%"
                  class="w-100 infoWindow"
                  header="Statistical Analysis">
                    <table class="statistics">
                      <thead>
                          <tr>
                            <th scope="col" class="first-col">Scanner</th>
                            <th scope="col" class="second-col">Verdict</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr v-for="(stat, index) in stats" :key="index">
                              <td class="api"> {{ stat }} </td>
                              <td :class="[index === '0' ? benignClass : maliciousClass]">
                              {{ index === '0' ? 'benign' : 'malicious' }} </td>
                          </tr>
                      </tbody>
                    </table>
                  </b-card>
                </b-row>
            </b-col>
            <b-col class="md-6">
              <b-card header="Long Form Data">
                <div class="longFormData">
                <table class="table table-dark table-striped table-hover">
                  <thead>
                      <tr>
                        <th scope="col" class="first-col">Field</th>
                        <th scope="col" class="second-col">Virus Total</th>
                        <th scope="col" class="second-col">Hybrid Analysis</th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr v-for="(value, field) in hybrid_values" :key="field">
                          <td class="infoData"> {{ field }} </td>
                          <td class="infoValue"> {{ hybrid_values[field] }} </td>
                          <td class="infoValue"> {{ virustotal_values[field] }} </td>
                      </tr>
                  </tbody>
                </table>
                </div>
              </b-card>
              </b-col>
            </b-row>
        <hr />
      </b-container>
    </b-row>
  </b-container>
</template>

<script>
import axios from 'axios';
/* import Alert from './Alert.vue'; */

export default {
  data() {
    return {
      books: [],
      sections: [{ value: 25 }, { value: 25 }],
      addBookForm: {
        title: '',
        author: '',
        read: [],
      },
      message: '',
      mitre: {},
      stats: [],
      showMessage: false,
      file: null,
      submitted: false,
      reportFetched: false,
      report: {},
      longFormData: {},
      processing: false,
      threat_score: null,
      perPage: 1,
      currentPage: 1,
      maliciousClass: 'malicious',
      benignClass: 'benign',
      fieldsStats:
      [
        {
          label: 'AnyRun ',
          key: 'AnyRun',
          sortable: true,
        },
        {
          label: 'FileScanIO',
          key: 'FileScanIO',
          sortable: true,
        },
        {
          label: 'Hybrid Analysis',
          key: 'Hybrid Analysis',
          sortable: true,
        },
        {
          label: 'VirusTotal',
          key: 'VirusTotal',
          sortable: true,
        },
      ],
      fields: [
        {
          label: 'Title',
          key: 'title',
          sortable: true,
        },
        {
          label: 'Verdict',
          key: 'Verdict',
          sortable: true,
        },
        {
          label: 'ThreatLevel',
          key: 'ThreatScore',
          sortable: true,
        },
        {
          label: 'Confidence',
          key: 'Confidence',
          sortable: true,
        },
        {
          label: 'FileName',
          key: 'FileName',
          sortable: true,
        },
        {
          label: 'Hash',
          key: 'Hash',
          sortable: true,
        },
        {
          label: 'Family',
          key: 'Family',
          sortable: true,
        },
        {
          label: 'Final Score',
          key: 'Final_score',
          sortable: true,
        },
        {
          label: 'Final Verdict',
          key: 'Final_verdict',
          sortable: true,
        },
      ],
      items: [
        { id: 1, first_name: 'Fred', last_name: 'Flintstone' },
        { id: 2, first_name: 'Wilma', last_name: 'Flintstone' },
        { id: 3, first_name: 'Barney', last_name: 'Rubble' },
        { id: 4, first_name: 'Betty', last_name: 'Rubble' },
        { id: 5, first_name: 'Pebbles', last_name: 'Flintstone' },
        { id: 6, first_name: 'Bamm Bamm', last_name: 'Rubble' },
        { id: 7, first_name: 'The Great', last_name: 'Gazzoo' },
        { id: 8, first_name: 'Rockhead', last_name: 'Slate' },
        { id: 9, first_name: 'Pearl', last_name: 'Slaghoople' },
      ],
      extracted_files: [],
      hybrid_values: {},
      virustotal_values: {},
    };
  },
  components: {
    // alert: Alert,
  },
  methods: {
    clearFiles() {
      this.$refs['file-input'].reset();
    },
    createThreatScoreChart(score) {
      this.threat_score = score;
      const y = score.split('/');
      const malicious = y[0] / y[1];
      const benign = 1 - malicious;
      let c1;
      let c2;
      if (malicious > 0.5) {
        c1 = 'rgb(255, 61, 113)';
        c2 = '#6c757d';
      } else if (malicious < 0.5) {
        c1 = '#6c757d';
        c2 = 'rgb(0, 214, 143)';
      } else {
        c1 = 'rgb(255, 61, 113)';
        c2 = 'rgb(0, 214, 143)';
      }

      this.sections = [
        { label: 'Malicious', value: malicious * 100, color: c1 },
        { label: 'Not Malicious', value: benign * 100, color: c2 }];
    },
    formatReport(report) {
      for (let i = 0; i < report.length; i += 1) {
        const result = report[i];
        const { title } = result;
        if (title === 'Hybrid.json') {
          this.hybrid_values = result;
        } else if (title === 'VirusTotal.json') {
          this.virustotal_values = result;
        }
      }
    },
    getReport() {
      this.processing = false;
      const path = 'http://localhost:5000/malware';

      axios.get(path)
        .then((res) => {
          this.reportFetched = true;
          this.report = res.data.report;
          this.formatReport(this.report.slice(0, -2));

          this.extracted_files = this.report.extracted_files;
          this.score = this.report[this.report.length - 1].Final_score;
          this.createThreatScoreChart(this.score);

          this.mitre = {};
          this.stats = this.report[this.report.length - 2].Final_verdict;

          /*
          for (let i = 0; i < res.data.rows; i += 1) {
            if ('Mitre' in res.data[i]) {
              this.mitre.append(res.data[i].Mitre);
            }
          }
          */
        })
        .catch((error) => {
          // eslint-disable-next-line
          console.error(error);
        });
    },
    submitFile() {
      const formData = new FormData();
      formData.append('file', this.file);
      this.submitted = true;
      this.processing = true;
      const payload = {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      };
      const path = 'http://localhost:5000/malware';
      axios.post(path, formData, payload)
        .then(() => {
          this.getReport();
        })
        .catch((error) => {
          // eslint-disable-next-line
          console.error(error);
        });
    },
  },
  getColour(item) {
    if (item === '0') {
      return 'red';
    }
    return 'green';
  },
  created() {
    document.body.style.backgroundColor = '#151a30';
  },
  destroyed() {
    document.body.style.backgroundColor = null;
  },
  computed: {
    totalRows() {
      return this.report.length - 2; // Last two items are verdict and score
    },
  },
};
</script>

<style scoped>

container {
  margin-left: 30%;
  margin-right: 30%;
}

#title {
  background: #222b45;
  color: #fff;
  padding: 2%;
  border-radius: 25px;
  border: 2px solid #8f9bb3;
}

#title h1 {
  font-weight: 400;
}

h4 {
  font-family: Open Sans,sans-serif;
  color: #fff;
  font-weight: 400;
  margin: 30px 0px 0px 30px;
}

.card{
  background: #222b45;
  margin-left: 30px;
}

.card-header {
    padding: 1rem 1.25rem;
    background: #222b45;
    border-bottom: 1px solid #151a30;
    border-top-left-radius: 0.25rem;
    border-top-right-radius: 0.25rem;
    color: #fff;
    font-family: Open Sans,sans-serif;
    font-size: .9375rem;
    font-weight: 600;
    line-height: 1.5r
}

.card-title {
  text-align: left;
  margin-top: -20px;
  margin-left: 10px;
  font-family: Open Sans,sans-serif;
  font-weight: 200;
  font-size: 30px;
}

.card-body {
  padding-left: 5px;
  padding-right: 5px;
}

.info {
  font-family: Open Sans,sans-serif;
  font-size: 16px;
  margin-top: -8px;
  font-weight: bold;
  margin-bottom: -4px;
  margin-left: 11px;
  color: #fff;
}

.label {
  font-family: Open Sans,sans-serif;
  opacity: .7;
  font-size: 12px;
  margin-left: 11px;
  margin-top: -6px;
  margin-bottom: -4px;
}

.list-group-flush > .list-group-item {
    border-width: 0 0 1px;
    border-color: #151a30;
    background: #222b45;
    color: #fff;
}

.table {
  font-family: Open Sans,sans-serif;
  color: #fff;
  font-weight: 400;
  line-height: 1.25rem;
  background-color: #222b45;
  border: 0 solid transparent;
  table-layout: fixed;
  width: 100%;
  overflow-x: scroll;

}

hr{
  height: 1px;
  background-color: #fff;
  border: none;
}

#donut {
  position:absolute;
  margin-right: 5%;
  margin-top: 1rem;
  top:0;
  right:0;
  z-index: 2;
  font-size: 2rem;
  font-weight: 300;
  color: white;
  opacity: 0.9;
}

#donut h5 {
  font-family: Open Sans,sans-serif;
  color: #fff;
  font-weight: bold;
  font-size: 15px;
  margin-left: 2px;
}

table.statistics {
    border-collapse:separate;
    border-spacing:0 5px;
    width:80%;
    padding-left: 1em;
    color: #fff;
}

th.first-col {
  text-align: left;
}

th.second-col {
  text-align: center;
  margin: 0 auto;
}

td.api {
  font-family: Open Sans,sans-serif;
  font-size: 1rem;
  font-weight: 200;
}

td.benign {
    background-color: #00d68f;
    border-radius: 0.25rem;
    font-family: Open Sans,sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    line-height: .75rem;
    padding: 0.25rem 0.4rem;
    width: 1em;
    text-align:center;
}

td.malicious {
    background-color: #ff3d71;
    border-radius: 0.25rem;
    font-family: Open Sans,sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    line-height: .75rem;
    padding: 0.25rem 0.4rem;
    width: 1em;
    text-align:center;
}

td.infoData {
  font-family: Open Sans,sans-serif;
  font-size: 1rem;
  font-weight: 200;
  font-variant: small-caps;
  width: 20%;
}

td.infoValue {
  font-family: Open Sans,sans-serif;
  font-size: 1rem;
  font-weight: 100;
  width: 40%;
}

.longFormData {
  overflow: auto;
  height: 400px;
}

.longFormData thead th {
  position: sticky;
  background: #1e6bb8;
  top: 0;
  z-index: 1;
}

h5.results {
  font-family: Open Sans,sans-serif;
  background-color: #fa0;
  border-radius: 0.5rem;
  color: #fff;
  font-weight: 50;
  font-size: 22px;
  text-align: center;
  padding-top: 5px;
  padding-bottom: 5px;
  width:6em;
}

.scrolling {
  max-height: 500px !important;
}

</style>
