from flask import Flask, jsonify, request
from flask_cors import CORS
import malware_api
import uuid
import sys
import json
import os

global REPORTS

DEBUG = True

sample_dir = 'sample/'

def reset_report():
    for r in REPORT:
        REPORT.remove(r)


app = Flask(__name__)
app.config.from_object(__name__)

CORS(app, resources={r'/*': {'origins': '*'}})

@app.route('/malware', methods=['GET', 'POST'])
def upload_file():
    global REPORTS
    response_object = {'status': 'success'}
    if request.method == 'POST':
        # check if the post request has the file part
        if 'file' not in request.files:
            flash('No file part')
            return redirect(request.url)

        REPORTS = [] 

        file = request.files['file']

        sample_path = os.path.join(sample_dir, file.filename)

        # Writes file to server/sample directory so filepath upload is supported
        with open(sample_path, 'wb') as outfile:
            outfile.write(file.read())

        report = malware_api.get_report(sample_path)  
        REPORTS = json.loads(str(report))

        response_object['message'] = 'Malware submitted!'
    else: 
        response_object['report'] = REPORTS

    return jsonify(response_object)


if __name__ == '__main__':
    app.run()
